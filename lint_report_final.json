[{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\eslint.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\next.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\postcss.config.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\api\\inaproc\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2074,2077],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2074,2077],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { NextResponse } from 'next/server';\r\n\r\nconst BASE_URL = 'https://data.inaproc.id/api';\r\nconst JWT_TOKEN = process.env.JWT_TOKEN;\r\n\r\nexport async function GET(request: Request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const endpoint = searchParams.get('endpoint') || '/v1/ekatalog-archive/paket-e-purchasing';\r\n    const year = searchParams.get('year') || '2024';\r\n    const limit = searchParams.get('limit') || '50';\r\n    const cursor = searchParams.get('cursor');\r\n\r\n    if (!JWT_TOKEN) {\r\n        return NextResponse.json({ error: 'JWT_TOKEN not configured' }, { status: 500 });\r\n    }\r\n\r\n    // Basic security check to ensure it hits the API and not some internal path\r\n    if (!endpoint.startsWith('/v1/') && !endpoint.startsWith('/legacy/')) {\r\n        return NextResponse.json({ error: 'Invalid endpoint' }, { status: 400 });\r\n    }\r\n\r\n    try {\r\n        let apiUrl = `${BASE_URL}${endpoint}?limit=${limit}&tahun=${year}`;\r\n\r\n        // Add kode_klpd for ALL endpoints (both V1 and Legacy require it)\r\n        apiUrl += `&kode_klpd=K34`;\r\n\r\n        if (cursor) {\r\n            apiUrl += `&cursor=${encodeURIComponent(cursor)}`;\r\n        }\r\n\r\n        const res = await fetch(apiUrl, {\r\n            headers: {\r\n                'Authorization': `Bearer ${JWT_TOKEN}`,\r\n                'Accept': 'application/json',\r\n                'Content-Type': 'application/json',\r\n            },\r\n        });\r\n\r\n        if (!res.ok) {\r\n            const errorText = await res.text();\r\n            return NextResponse.json({ error: `API Error: ${res.status} - ${errorText}` }, { status: res.status });\r\n        }\r\n\r\n        const data = await res.json();\r\n\r\n        // Normalize Legacy API response (direct array) to standard format\r\n        if (Array.isArray(data)) {\r\n            return NextResponse.json({\r\n                data: data,\r\n                meta: { total: data.length },\r\n                has_more: false // Legacy typically returns all data at once\r\n            });\r\n        }\r\n\r\n        return NextResponse.json(data);\r\n\r\n    } catch (error: any) {\r\n        return NextResponse.json({ error: error.message }, { status: 500 });\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\api\\sync\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":62,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":62,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1851,1854],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1851,1854],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":151,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5223,5226],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5223,5226],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6689,6692],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6689,6692],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":228,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":228,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8305,8308],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8305,8308],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":312,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":312,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11814,11817],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11814,11817],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":347,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":347,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12781,12784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12781,12784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Sync API Route\r\n * Handles incremental data synchronization for INAPROC endpoints\r\n */\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport { getSyncState, updateSyncState, ensureEndpointFolder } from '@/lib/sync-state';\r\nimport { appendToExcel, overwriteExcel, getFileInfo } from '@/lib/excel-service';\r\nimport { getFilePath } from '@/lib/drive-config';\r\n\r\nconst BASE_URL = 'https://data.inaproc.id/api';\r\nconst JWT_TOKEN = process.env.JWT_TOKEN;\r\n\r\n// Configuration for retries\r\nconst RETRY_CONFIG = {\r\n    maxRetries: 3,\r\n    initialDelay: 1000,\r\n    maxDelay: 10000,\r\n    timeout: 30000, // 30 seconds\r\n};\r\n\r\ninterface SyncResult {\r\n    success: boolean;\r\n    endpoint: string;\r\n    year: string;\r\n    newRecords: number;\r\n    duplicatesSkipped: number;\r\n    totalRecords: number;\r\n    filePath: string;\r\n    isComplete: boolean;\r\n    error?: string;\r\n    verificationStatus?: 'verified' | 'mismatch' | 'unchecked';\r\n}\r\n\r\n/**\r\n * Fetch with retry logic and timeout\r\n */\r\nasync function fetchWithRetry(url: string, options: RequestInit, retryCount = 0): Promise<Response> {\r\n    try {\r\n        // Create controller for timeout\r\n        const controller = new AbortController();\r\n        const timeoutId = setTimeout(() => controller.abort(), RETRY_CONFIG.timeout);\r\n\r\n        const res = await fetch(url, {\r\n            ...options,\r\n            signal: controller.signal,\r\n        });\r\n\r\n        clearTimeout(timeoutId);\r\n\r\n        // Success or non-retriable error\r\n        if (res.ok || res.status === 400 || res.status === 401 || res.status === 404) {\r\n            return res;\r\n        }\r\n\r\n        // Retriable status codes (Server errors, Rate limit)\r\n        if ([429, 500, 502, 503, 504].includes(res.status)) {\r\n            throw new Error(`Retriable error: ${res.status}`);\r\n        }\r\n\r\n        return res;\r\n    } catch (error: any) {\r\n        if (retryCount >= RETRY_CONFIG.maxRetries) {\r\n            throw error;\r\n        }\r\n\r\n        // Calculate backoff delay\r\n        const delay = Math.min(\r\n            RETRY_CONFIG.initialDelay * Math.pow(2, retryCount),\r\n            RETRY_CONFIG.maxDelay\r\n        );\r\n\r\n        console.log(`Sync request failed (${error.message}). Retrying in ${delay}ms... (Attempt ${retryCount + 1}/${RETRY_CONFIG.maxRetries})`);\r\n\r\n        await new Promise(resolve => setTimeout(resolve, delay));\r\n        return fetchWithRetry(url, options, retryCount + 1);\r\n    }\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const body = await request.json();\r\n        const { endpoint, year, batchSize = 100, maxPages = 10 } = body;\r\n\r\n        if (!endpoint || !year) {\r\n            return NextResponse.json(\r\n                { error: 'Missing required fields: endpoint, year' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        if (!JWT_TOKEN) {\r\n            return NextResponse.json(\r\n                { error: 'JWT_TOKEN not configured' },\r\n                { status: 500 }\r\n            );\r\n        }\r\n\r\n        // Basic security check - allow both v1 and legacy endpoints\r\n        if (!endpoint.startsWith('/v1/') && !endpoint.startsWith('/legacy/')) {\r\n            return NextResponse.json(\r\n                { error: 'Invalid endpoint' },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Block detail endpoints that require specific IDs (like kd_distributor)\r\n        const detailEndpoints = [\r\n            'penyedia-distributor-detail',\r\n            'komoditas-detail',\r\n            'penyedia-detail'\r\n        ];\r\n        if (detailEndpoints.some(de => endpoint.includes(de))) {\r\n            return NextResponse.json(\r\n                {\r\n                    error: 'This endpoint requires a specific ID parameter and cannot be synced in bulk',\r\n                    hint: 'Detail endpoints need additional parameters like kd_distributor or kd_komoditas'\r\n                },\r\n                { status: 400 }\r\n            );\r\n        }\r\n\r\n        // Ensure folder exists\r\n        await ensureEndpointFolder(endpoint);\r\n\r\n        // Get current sync state\r\n        const currentState = await getSyncState(endpoint, year);\r\n\r\n        // Check if file actually exists - if not, reset sync state\r\n        const fileInfo = await getFileInfo(endpoint, year);\r\n        let currentCursor: string | null = null;\r\n        let finalVerification: 'verified' | 'mismatch' | 'unchecked' = 'unchecked';\r\n\r\n        if (fileInfo.exists && currentState?.lastCursor) {\r\n            // File exists and we have a cursor, continue from where we left off\r\n            currentCursor = currentState.lastCursor;\r\n            console.log(`Continuing sync from cursor for ${endpoint} ${year}`);\r\n        } else if (!fileInfo.exists && currentState?.totalRecords) {\r\n            // File was deleted but state exists, reset and start fresh\r\n            console.log(`File missing for ${endpoint} ${year}, starting fresh sync`);\r\n            currentCursor = null;\r\n        } else {\r\n            console.log(`Starting new sync for ${endpoint} ${year}`);\r\n        }\r\n\r\n        let totalNewRecords = 0;\r\n        let totalDuplicatesSkipped = 0;\r\n        let pagesFetched = 0;\r\n        let isComplete = false;\r\n\r\n        const accumulatedData: any[] = [];\r\n        let finalCursor: string | null = currentCursor;\r\n\r\n        // Fetch data in pages\r\n        while (pagesFetched < maxPages) {\r\n            // Build API URL\r\n            let apiUrl = `${BASE_URL}${endpoint}?limit=${batchSize}&tahun=${year}`;\r\n\r\n            // Add kode_klpd for ALL endpoints (both V1 and Legacy require it)\r\n            if (endpoint.startsWith('/v1/')) {\r\n                apiUrl += `&kode_klpd=K34`;\r\n            } else {\r\n                apiUrl += `&kode_klpd=K34`; // Explicitly for legacy too as confirmed\r\n            }\r\n\r\n            if (currentCursor) {\r\n                apiUrl += `&cursor=${encodeURIComponent(currentCursor)}`;\r\n            }\r\n\r\n            // Fetch from INAPROC API with retry\r\n            try {\r\n                const res = await fetchWithRetry(apiUrl, {\r\n                    headers: {\r\n                        'Authorization': `Bearer ${JWT_TOKEN}`,\r\n                        'Accept': 'application/json',\r\n                        'Content-Type': 'application/json',\r\n                    },\r\n                });\r\n\r\n                if (!res.ok) {\r\n                    const errorText = await res.text().catch(() => 'Unknown error');\r\n                    throw new Error(`API Error: ${res.status} - ${errorText}`);\r\n                }\r\n\r\n                const result = await res.json();\r\n\r\n                // Legacy API returns data as direct array, V1 returns {data: [...]}\r\n                let pageData: any[];\r\n                let hasMoreData = false;\r\n                let nextCursor: string | null = null;\r\n\r\n                if (Array.isArray(result)) {\r\n                    // Legacy API: direct array response (no pagination)\r\n                    pageData = result;\r\n                    hasMoreData = false; // Legacy APIs typically return all data at once\r\n                } else {\r\n                    // V1 API: wrapped in data field with pagination\r\n                    pageData = result.data || result.rs || [];\r\n                    nextCursor = result.cursor || (result.meta && result.meta.cursor) || null;\r\n                    hasMoreData = !!nextCursor && result.has_more !== false;\r\n                }\r\n\r\n                if (pageData.length === 0) {\r\n                    // No more data on this page\r\n                    if (pagesFetched === 0 && accumulatedData.length === 0) {\r\n                        isComplete = true; // Truly empty\r\n                    }\r\n                    break;\r\n                }\r\n\r\n                // Accumulate data\r\n                accumulatedData.push(...pageData);\r\n\r\n                // Update cursors for next iteration\r\n                finalCursor = nextCursor;\r\n                currentCursor = nextCursor;\r\n                pagesFetched++;\r\n\r\n                // Check if we should continue fetching\r\n                if (!hasMoreData) {\r\n                    isComplete = true;\r\n                    break;\r\n                }\r\n\r\n                // Small delay to be nice to the API\r\n                await new Promise((r) => setTimeout(r, 200));\r\n\r\n            } catch (error: any) {\r\n                console.error(`Error during sync page ${pagesFetched + 1}:`, error);\r\n                // Stop fetching on error, but save what we have accumulated so far\r\n                break;\r\n            }\r\n        }\r\n\r\n        // Bulk Write to Excel (if we have data)\r\n        if (accumulatedData.length > 0) {\r\n            console.log(`Bulk writing ${accumulatedData.length} records...`);\r\n\r\n            let excelResult;\r\n\r\n            const isLegacy = endpoint.startsWith('/legacy/');\r\n\r\n            // For Legacy + Complete Fetch, use Overwrite to ensure no duplicates\r\n            if (isLegacy && isComplete) {\r\n                console.log('Legacy Endpoint + Full Fetch detected: Using Overwrite Strategy');\r\n                excelResult = await overwriteExcel(endpoint, year, accumulatedData);\r\n            } else {\r\n                if (isLegacy && !isComplete) {\r\n                    console.warn('Legacy sync incomplete! Falling back to Append Strategy.');\r\n                }\r\n                const res = await appendToExcel(endpoint, year, accumulatedData);\r\n                excelResult = res;\r\n            }\r\n\r\n            if (!excelResult.success) {\r\n                throw new Error(excelResult.error || 'Failed to append to Excel');\r\n            }\r\n\r\n            totalNewRecords = excelResult.newRecords;\r\n            totalDuplicatesSkipped = excelResult.duplicatesSkipped;\r\n\r\n            // Update state ONLY after successful write\r\n            const newState = {\r\n                lastCursor: finalCursor || null,\r\n                totalRecords: excelResult.totalRecords,\r\n                filePath: excelResult.filePath,\r\n            };\r\n\r\n            await updateSyncState(endpoint, year, newState);\r\n\r\n            // Final verification logic\r\n            if (isComplete) {\r\n                const finalFileCheck = await getFileInfo(endpoint, year);\r\n                if (finalFileCheck.recordCount === newState.totalRecords) {\r\n                    finalVerification = 'verified';\r\n                } else {\r\n                    finalVerification = 'mismatch';\r\n                }\r\n            }\r\n        } else if (isComplete && totalNewRecords === 0) {\r\n            // Handle case where we marked generic complete but had no data to write (e.g. empty final page or legacy empty)\r\n            // We still might need to verify existing state if we thought we were starting fresh?\r\n            // But usually if accumulatedData is 0, we did nothing.\r\n        }\r\n\r\n        // Get final file info\r\n        const finalFileInfo = await getFileInfo(endpoint, year);\r\n\r\n        // If we didn't verify inside the loop (e.g. maxPages hit), verify now\r\n        if (finalVerification === 'unchecked' && isComplete) {\r\n            const currentState = await getSyncState(endpoint, year);\r\n            if (currentState && currentState.totalRecords === finalFileInfo.recordCount) {\r\n                finalVerification = 'verified';\r\n            } else {\r\n                finalVerification = 'mismatch';\r\n            }\r\n        }\r\n\r\n        const syncResult: SyncResult = {\r\n            success: true,\r\n            endpoint,\r\n            year,\r\n            newRecords: totalNewRecords,\r\n            duplicatesSkipped: totalDuplicatesSkipped,\r\n            totalRecords: finalFileInfo.recordCount,\r\n            filePath: getFilePath(endpoint, year),\r\n            isComplete,\r\n            verificationStatus: finalVerification\r\n        };\r\n\r\n        return NextResponse.json(syncResult);\r\n    } catch (error: any) {\r\n        console.error('Sync error:', error);\r\n        return NextResponse.json(\r\n            {\r\n                success: false,\r\n                error: error.message,\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\nexport async function GET(request: Request) {\r\n    // GET method for checking sync status\r\n    const { searchParams } = new URL(request.url);\r\n    const endpoint = searchParams.get('endpoint');\r\n    const year = searchParams.get('year');\r\n\r\n    if (!endpoint || !year) {\r\n        return NextResponse.json(\r\n            { error: 'Missing required params: endpoint, year' },\r\n            { status: 400 }\r\n        );\r\n    }\r\n\r\n    try {\r\n        const state = await getSyncState(endpoint, year);\r\n        const fileInfo = await getFileInfo(endpoint, year);\r\n\r\n        return NextResponse.json({\r\n            endpoint,\r\n            year,\r\n            syncState: state,\r\n            fileInfo,\r\n        });\r\n    } catch (error: any) {\r\n        return NextResponse.json(\r\n            { error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\api\\sync\\schedule\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'getAllSyncStates' is defined but never used.","line":11,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":11,"endColumn":21,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"getAllSyncStates"},"fix":{"range":[205,228],"text":""},"desc":"Remove unused variable \"getAllSyncStates\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[605,608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[605,608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":39,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[954,957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[954,957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1687,1690],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1687,1690],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2188,2191],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2188,2191],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Schedule API Route\r\n * Manages sync scheduling configuration\r\n */\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport {\r\n    getScheduleConfig,\r\n    updateScheduleConfig,\r\n    isScheduledSyncDue,\r\n    getAllSyncStates,\r\n} from '@/lib/sync-state';\r\nimport { ENDPOINTS } from '@/lib/constants';\r\n\r\n// GET - Get current schedule config\r\nexport async function GET() {\r\n    try {\r\n        const schedule = await getScheduleConfig();\r\n        const isDue = await isScheduledSyncDue();\r\n\r\n        return NextResponse.json({\r\n            schedule,\r\n            isDue,\r\n        });\r\n    } catch (error: any) {\r\n        return NextResponse.json(\r\n            { error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n// POST - Update schedule config\r\nexport async function POST(request: Request) {\r\n    try {\r\n        const body = await request.json();\r\n        const { enabled, type, endpoints } = body;\r\n\r\n        const updates: any = {};\r\n\r\n        if (typeof enabled === 'boolean') {\r\n            updates.enabled = enabled;\r\n        }\r\n\r\n        if (type === 'daily' || type === 'weekly') {\r\n            updates.type = type;\r\n        }\r\n\r\n        if (Array.isArray(endpoints)) {\r\n            // Validate endpoints exist\r\n            const validEndpoints = endpoints.filter((ep: string) =>\r\n                ENDPOINTS.some((e) => e.value === ep)\r\n            );\r\n            updates.endpoints = validEndpoints;\r\n        }\r\n\r\n        await updateScheduleConfig(updates);\r\n        const newSchedule = await getScheduleConfig();\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            schedule: newSchedule,\r\n        });\r\n    } catch (error: any) {\r\n        return NextResponse.json(\r\n            { error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n// PUT - Mark schedule as run (update lastRun)\r\nexport async function PUT() {\r\n    try {\r\n        await updateScheduleConfig({\r\n            lastRun: new Date().toISOString(),\r\n        });\r\n\r\n        const schedule = await getScheduleConfig();\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            schedule,\r\n        });\r\n    } catch (error: any) {\r\n        return NextResponse.json(\r\n            { error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\api\\sync\\status\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'updateSyncState' is defined but never used.","line":8,"column":61,"nodeType":"Identifier","messageId":"unusedVar","endLine":8,"endColumn":76,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"updateSyncState"},"fix":{"range":[282,299],"text":""},"desc":"Remove unused variable \"updateSyncState\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4410,4413],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4410,4413],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Sync Status API Route\r\n * Returns the sync status for all endpoints or a specific endpoint\r\n * Also verifies file existence and updates state if files are missing\r\n */\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport { getAllSyncStates, getScheduleConfig, getSyncState, updateSyncState, resetSyncState } from '@/lib/sync-state';\r\nimport { getFileInfo } from '@/lib/excel-service';\r\nimport { ENDPOINTS } from '@/lib/constants';\r\n\r\nexport async function GET(request: Request) {\r\n    const { searchParams } = new URL(request.url);\r\n    const endpoint = searchParams.get('endpoint');\r\n    const year = searchParams.get('year');\r\n    const verifyFiles = searchParams.get('verify') !== 'false'; // Default to true\r\n\r\n    try {\r\n        // If specific endpoint requested\r\n        if (endpoint && year) {\r\n            const state = await getSyncState(endpoint, year);\r\n            const fileInfo = await getFileInfo(endpoint, year);\r\n            const schedule = await getScheduleConfig();\r\n\r\n            // If state says we have records but file doesn't exist, reset state\r\n            if (verifyFiles && state?.totalRecords && !fileInfo.exists) {\r\n                console.log(`File missing for ${endpoint} ${year}, resetting state`);\r\n                await resetSyncState(endpoint, year);\r\n                return NextResponse.json({\r\n                    endpoint,\r\n                    year,\r\n                    state: null,\r\n                    fileInfo,\r\n                    schedule,\r\n                });\r\n            }\r\n\r\n            return NextResponse.json({\r\n                endpoint,\r\n                year,\r\n                state,\r\n                fileInfo,\r\n                schedule,\r\n            });\r\n        }\r\n\r\n        // Return all states with file verification\r\n        const allStates = await getAllSyncStates();\r\n        const schedule = await getScheduleConfig();\r\n\r\n        // Build comprehensive status for all endpoints with file verification\r\n        const endpointStatusesPromises = ENDPOINTS.map(async (ep) => {\r\n            const endpointStates = allStates[ep.value] || {};\r\n            const years = Object.keys(endpointStates);\r\n\r\n            // Verify files for each year and update state if needed\r\n            const verifiedYears = await Promise.all(\r\n                years.map(async (y) => {\r\n                    const state = endpointStates[y];\r\n                    const fileInfo = await getFileInfo(ep.value, y);\r\n\r\n                    // If file doesn't exist but state has records, reset\r\n                    if (verifyFiles && state?.totalRecords && !fileInfo.exists) {\r\n                        console.log(`File missing for ${ep.value} ${y}, clearing from status`);\r\n                        await resetSyncState(ep.value, y);\r\n                        return null; // Will be filtered out\r\n                    }\r\n\r\n                    return {\r\n                        year: y,\r\n                        state: {\r\n                            ...state,\r\n                            // Update totalRecords from actual file if exists\r\n                            totalRecords: fileInfo.exists ? fileInfo.recordCount : 0,\r\n                        },\r\n                        fileExists: fileInfo.exists,\r\n                    };\r\n                })\r\n            );\r\n\r\n            // Filter out null entries (deleted files)\r\n            const validYears = verifiedYears.filter((y) => y !== null);\r\n\r\n            return {\r\n                endpoint: ep.value,\r\n                label: ep.label,\r\n                years: validYears,\r\n                lastSynced: validYears.length > 0\r\n                    ? validYears.reduce((latest, item) => {\r\n                        if (!item) return latest;\r\n                        const stateDate = new Date(item.state.lastSyncDate);\r\n                        return stateDate > latest ? stateDate : latest;\r\n                    }, new Date(0))\r\n                    : null,\r\n            };\r\n        });\r\n\r\n        const endpointStatuses = await Promise.all(endpointStatusesPromises);\r\n\r\n        console.log('Refresh complete - verified all file states');\r\n\r\n        return NextResponse.json({\r\n            endpoints: endpointStatuses,\r\n            schedule,\r\n            basePath: process.env.SYNC_LOCATION || process.env.INAPROC_DATA_PATH || 'C:/Users/User/Documents/Aldiva/01 - DATABASE INAPROC LKPP',\r\n        });\r\n    } catch (error: any) {\r\n        console.error('Error getting sync status:', error);\r\n        return NextResponse.json(\r\n            { error: error.message },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\layout.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\app\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":36,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":36,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1162,1165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1162,1165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":44,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1552,1555],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1552,1555],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1725,1728],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1725,1728],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2644,2647],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2644,2647],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":232,"column":8,"nodeType":"ArrayExpression","endLine":232,"endColumn":32,"suggestions":[{"desc":"Update the dependencies array to be: [year, selectedEndpoint, fetchData]","fix":{"range":[8540,8564],"text":"[year, selectedEndpoint, fetchData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":263,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":263,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9676,9679],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9676,9679],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'e' is defined but never used.","line":515,"column":78,"nodeType":"Identifier","messageId":"unusedVar","endLine":515,"endColumn":79}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\n'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport {\r\n    TableBody,\r\n    TableCell,\r\n    TableHead,\r\n    TableHeader,\r\n    TableRow,\r\n} from \"@/components/ui/table\";\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectGroup,\r\n    SelectItem,\r\n    SelectLabel,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { Loader2, Search, Filter, Database, TrendingUp, DollarSign, Eye, Download, FolderSync, TableIcon, AlertTriangle } from \"lucide-react\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { DetailSheet } from \"@/components/detail-sheet\";\r\nimport { SyncManager } from \"@/components/sync-manager\";\r\nimport { RangeSyncManager } from \"@/components/range-sync-manager\";\r\nimport { ENDPOINTS } from \"@/lib/constants\";\r\n\r\n\r\nexport default function Home() {\r\n    // Dynamic Endpoint\r\n    const [selectedEndpoint, setSelectedEndpoint] = useState(ENDPOINTS[0].value);\r\n\r\n    const [data, setData] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [year, setYear] = useState('2024');\r\n    const [search, setSearch] = useState('');\r\n    const [cursor, setCursor] = useState<string | null>(null);\r\n    const [hasMore, setHasMore] = useState(false);\r\n\r\n    // Client-side pagination state for Legacy endpoints\r\n    const [allLegacyData, setAllLegacyData] = useState<any[]>([]);\r\n    const [legacyPage, setLegacyPage] = useState(0);\r\n    const ROWS_PER_PAGE = 50;\r\n\r\n    // Sheet state\r\n    const [selectedItem, setSelectedItem] = useState<any | null>(null);\r\n    const [isSheetOpen, setIsSheetOpen] = useState(false);\r\n\r\n    // Tab state: 'browser' | 'sync' | 'range-sync'\r\n    const [activeTab, setActiveTab] = useState<'browser' | 'sync' | 'range-sync'>('browser');\r\n\r\n    // Dynamic Columns Helper\r\n    const getDynamicColumns = () => {\r\n        if (data.length === 0) return [];\r\n        const keys = new Set<string>();\r\n        // Sample first 5 items to get keys\r\n        data.slice(0, 5).forEach(item => {\r\n            Object.keys(item).forEach(k => keys.add(k));\r\n        });\r\n        return Array.from(keys);\r\n    };\r\n\r\n    const columns = getDynamicColumns();\r\n\r\n    // Export state\r\n    const [isExporting, setIsExporting] = useState(false);\r\n\r\n\r\n\r\n    const handleExport = async () => {\r\n        setIsExporting(true);\r\n        setIsExporting(true);\r\n\r\n        try {\r\n            const XLSX = await import(\"xlsx\");\r\n            let allExportData: any[] = [];\r\n            let currentCursor: string | null = null;\r\n            let keepFetching = true;\r\n            let pageCount = 0;\r\n\r\n            // Initial fetch params\r\n            const baseQuery = new URLSearchParams({\r\n                year,\r\n                limit: '100', // Fetch in larger chunks for export\r\n            });\r\n            if (search) {\r\n                baseQuery.set('search', search);\r\n            }\r\n\r\n            while (keepFetching) {\r\n                const query = new URLSearchParams(baseQuery);\r\n                if (currentCursor) {\r\n                    query.set('cursor', currentCursor);\r\n                }\r\n\r\n                const res = await fetch(`/api/inaproc?${query.toString()}`);\r\n                if (!res.ok) throw new Error(\"Failed to fetch data for export\");\r\n\r\n                const result = await res.json();\r\n                const pageData = result.data || [];\r\n\r\n                if (pageData.length === 0) {\r\n                    keepFetching = false;\r\n                } else {\r\n                    allExportData = [...allExportData, ...pageData];\r\n                    allExportData = [...allExportData, ...pageData];\r\n\r\n                    // Check cursor\r\n                    const nextCursor = result.cursor || (result.meta && result.meta.cursor);\r\n                    if (nextCursor && result.has_more !== false) {\r\n                        currentCursor = nextCursor;\r\n                    } else {\r\n                        keepFetching = false;\r\n                    }\r\n                }\r\n\r\n                // Safety break to prevent infinite loops during dev (remove or increase limit for prod)\r\n                if (pageCount > 100) break;\r\n                pageCount++;\r\n\r\n                // Small delay to be nice to API\r\n                await new Promise(r => setTimeout(r, 200));\r\n            }\r\n\r\n            // Create Excel\r\n            const worksheet = XLSX.utils.json_to_sheet(allExportData);\r\n            const workbook = XLSX.utils.book_new();\r\n            XLSX.utils.book_append_sheet(workbook, worksheet, `Data ${year}`);\r\n\r\n            // Generate filename\r\n            const filename = `INAPROC_Data_${year}_${new Date().toISOString().slice(0, 10)}.xlsx`;\r\n            XLSX.writeFile(workbook, filename);\r\n\r\n        } catch (error) {\r\n            console.error(\"Export failed:\", error);\r\n            alert(\"Export failed. See console for details.\");\r\n        } finally {\r\n            setIsExporting(false);\r\n        }\r\n    };\r\n\r\n    // Stats\r\n    const [stats, setStats] = useState({ totalItems: 0, totalPagu: 0 });\r\n\r\n    const fetchData = async (reset = false, nextCursor: string | null = null) => {\r\n        // Check if endpoint is restricted\r\n        const currentEp = ENDPOINTS.find(ep => ep.value === selectedEndpoint);\r\n        if (currentEp?.requiresId) {\r\n            setLoading(false);\r\n            setData([]); // Clear data\r\n            return;\r\n        }\r\n\r\n        // Client-side pagination logic for Legacy\r\n        if (!reset && nextCursor === 'CLIENT_SIDE' && allLegacyData.length > 0) {\r\n            const nextPage = legacyPage + 1;\r\n            const start = nextPage * ROWS_PER_PAGE;\r\n            const end = start + ROWS_PER_PAGE;\r\n            const nextChunk = allLegacyData.slice(start, end);\r\n\r\n            setData(prev => [...prev, ...nextChunk]);\r\n            setLegacyPage(nextPage);\r\n            setHasMore(end < allLegacyData.length);\r\n            return;\r\n        }\r\n\r\n        setLoading(true);\r\n        try {\r\n            const query = new URLSearchParams({\r\n                year,\r\n                limit: '50',\r\n                endpoint: selectedEndpoint,\r\n            });\r\n            if (nextCursor && nextCursor !== 'CLIENT_SIDE') {\r\n                query.set('cursor', nextCursor);\r\n            }\r\n            if (search) {\r\n                query.set('search', search);\r\n            }\r\n\r\n            const res = await fetch(`/api/inaproc?${query.toString()}`);\r\n            const result = await res.json();\r\n\r\n            if (result.data) {\r\n                if (reset) {\r\n                    // Check if it's a large legacy response (array without server pagination)\r\n                    // My normalized legacy API returns { data: [...], meta: { total: N }, has_more: false }\r\n                    const isLegacyLarge = result.meta?.total > ROWS_PER_PAGE && result.has_more === false;\r\n\r\n                    if (isLegacyLarge) {\r\n                        // Store massive dataset in memory and paginate locally\r\n                        setAllLegacyData(result.data);\r\n                        setData(result.data.slice(0, ROWS_PER_PAGE));\r\n                        setLegacyPage(0);\r\n                        setHasMore(true);\r\n                        setCursor('CLIENT_SIDE');\r\n                    } else {\r\n                        // Standard V1 or small legacy\r\n                        setAllLegacyData([]);\r\n                        setData(result.data);\r\n                        const newCursor = result.cursor || (result.meta && result.meta.cursor);\r\n                        setCursor(newCursor);\r\n                        setHasMore(!!newCursor);\r\n                    }\r\n                } else {\r\n                    setData(prev => {\r\n                        return [...prev, ...result.data];\r\n                    });\r\n\r\n                    const newCursor = result.cursor || (result.meta && result.meta.cursor);\r\n                    setCursor(newCursor);\r\n                    setHasMore(!!newCursor);\r\n                }\r\n            } else {\r\n                if (reset) setData([]);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to fetch data\", error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        setCursor(null);\r\n        setHasMore(false);\r\n        setData([]);\r\n        fetchData(true);\r\n    }, [year, selectedEndpoint]);\r\n\r\n    // Calculate stats based on CURRENT loaded data (simple approach) or formatted\r\n    // Ideally, stats come from API for \"Total\", but we'll sum up what we have.\r\n    useEffect(() => {\r\n        const priceKeys = ['total_harga', 'pagu', 'nilai_kontrak', 'nilai_pagu_paket', 'total_pagu'];\r\n        const totalPagu = data.reduce((acc, item) => {\r\n            for (const key of priceKeys) {\r\n                if (item[key]) {\r\n                    return acc + (parseFloat(item[key]) || 0);\r\n                }\r\n            }\r\n            return acc;\r\n        }, 0);\r\n\r\n        // If client-side pagination is active, show the TOTAL records, not just rendered ones\r\n        const totalCount = allLegacyData.length > 0 ? allLegacyData.length : data.length;\r\n        setStats({ totalItems: totalCount, totalPagu });\r\n    }, [data, allLegacyData]);\r\n\r\n    const handleSearch = (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        fetchData(true);\r\n    };\r\n\r\n    const loadMore = () => {\r\n        if (cursor) {\r\n            fetchData(false, cursor);\r\n        }\r\n    };\r\n\r\n    const openDetails = (item: any) => {\r\n        setSelectedItem(item);\r\n        setIsSheetOpen(true);\r\n    };\r\n\r\n    // Helper to format currency\r\n    const formatCurrency = (val: number) => {\r\n        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(val);\r\n    };\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-50/50 dark:bg-slate-950 text-slate-900 dark:text-slate-50 font-sans\">\r\n            {/* Detail Sheet Component */}\r\n            <DetailSheet\r\n                open={isSheetOpen}\r\n                onOpenChange={setIsSheetOpen}\r\n                data={selectedItem}\r\n            />\r\n\r\n            {/* Header / Hero */}\r\n            <header className=\"sticky top-0 z-40 w-full border-b bg-white/80 dark:bg-slate-950/80 backdrop-blur-md\">\r\n                <div className=\"container mx-auto flex h-16 items-center justify-between px-4 md:px-6\">\r\n                    <div className=\"flex items-center gap-2 font-bold text-xl tracking-tight text-blue-600 dark:text-blue-400\">\r\n                        <Database className=\"h-6 w-6\" />\r\n                        <span>INAPROC Visualizer</span>\r\n                    </div>\r\n                    <div className=\"flex items-center gap-4\">\r\n                        {/* Year Selector */}\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <span className=\"text-sm font-medium hidden sm:inline-block text-slate-500\">Tahun:</span>\r\n                            <Select value={year} onValueChange={setYear}>\r\n                                <SelectTrigger className=\"w-[100px] h-9\">\r\n                                    <SelectValue placeholder=\"Year\" />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {Array.from({ length: 2026 - 2018 + 1 }, (_, i) => 2026 - i).map((y) => (\r\n                                        <SelectItem key={y} value={String(y)}>\r\n                                            {y}\r\n                                        </SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n            </header>\r\n\r\n            <main className=\"container mx-auto px-4 md:px-6 py-8 space-y-8\">\r\n\r\n                {/* Stats Cards */}\r\n                <div className=\"grid gap-4 md:grid-cols-3\">\r\n                    <Card className=\"bg-white dark:bg-slate-900 border-none shadow-sm hover:shadow-md transition-shadow\">\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-slate-500\">Total Data Loaded</CardTitle>\r\n                            <Database className=\"h-4 w-4 text-slate-500\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">{stats.totalItems.toLocaleString()}</div>\r\n                            <p className=\"text-xs text-slate-500\">Rows fetched so far</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                    <Card className=\"bg-white dark:bg-slate-900 border-none shadow-sm hover:shadow-md transition-shadow\">\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-slate-500\">Total Pagu (Loaded)</CardTitle>\r\n                            <DollarSign className=\"h-4 w-4 text-emerald-500\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold truncate\" title={formatCurrency(stats.totalPagu)}>\r\n                                {formatCurrency(stats.totalPagu)}\r\n                            </div>\r\n                            <p className=\"text-xs text-slate-500\">Sum of visible pagu</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                    <Card className=\"bg-gradient-to-br from-blue-600 to-indigo-600 text-white border-none shadow-md\">\r\n                        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                            <CardTitle className=\"text-sm font-medium text-blue-100\">Status</CardTitle>\r\n                            <TrendingUp className=\"h-4 w-4 text-blue-100\" />\r\n                        </CardHeader>\r\n                        <CardContent>\r\n                            <div className=\"text-2xl font-bold\">{loading ? 'Syncing...' : 'Active'}</div>\r\n                            <p className=\"text-xs text-blue-100/70\">Connected to INAPROC API</p>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n\r\n                {/* Tab Navigation */}\r\n                <div className=\"flex gap-2 bg-white dark:bg-slate-900 p-2 rounded-lg shadow-sm border overflow-x-auto\">\r\n                    <Button\r\n                        variant={activeTab === 'browser' ? 'default' : 'ghost'}\r\n                        className={`gap-2 ${activeTab === 'browser' ? 'bg-blue-600 hover:bg-blue-700' : ''}`}\r\n                        onClick={() => setActiveTab('browser')}\r\n                    >\r\n                        <TableIcon className=\"h-4 w-4\" />\r\n                        Data Browser\r\n                    </Button>\r\n                    <Button\r\n                        variant={activeTab === 'sync' ? 'default' : 'ghost'}\r\n                        className={`gap-2 ${activeTab === 'sync' ? 'bg-indigo-600 hover:bg-indigo-700' : ''}`}\r\n                        onClick={() => setActiveTab('sync')}\r\n                    >\r\n                        <FolderSync className=\"h-4 w-4\" />\r\n                        Sync Manager\r\n                    </Button>\r\n                    <Button\r\n                        variant={activeTab === 'range-sync' ? 'default' : 'ghost'}\r\n                        className={`gap-2 ${activeTab === 'range-sync' ? 'bg-emerald-600 hover:bg-emerald-700' : ''}`}\r\n                        onClick={() => setActiveTab('range-sync')}\r\n                    >\r\n                        <TrendingUp className=\"h-4 w-4\" />\r\n                        Range Sync\r\n                    </Button>\r\n                </div>\r\n\r\n                {/* Range Sync Tab */}\r\n                {activeTab === 'range-sync' && (\r\n                    <RangeSyncManager />\r\n                )}\r\n\r\n                {/* Sync Manager Tab */}\r\n                {activeTab === 'sync' && (\r\n                    <SyncManager year={year} onSyncComplete={() => fetchData(true)} />\r\n                )}\r\n\r\n                {/* Data Browser Tab */}\r\n                {activeTab === 'browser' && (\r\n                    <>\r\n                        {/* Filters & Actions */}\r\n                        <div className=\"flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between bg-white dark:bg-slate-900 p-4 rounded-lg shadow-sm border sticky top-16 z-30\">\r\n                            <form onSubmit={handleSearch} className=\"relative w-full xl:w-96 shrink-0\">\r\n                                <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-slate-500\" />\r\n                                <Input\r\n                                    placeholder=\"Search packages...\"\r\n                                    className=\"pl-9 bg-slate-50 dark:bg-slate-950 border-none focus-visible:ring-1 w-full\"\r\n                                    value={search}\r\n                                    onChange={(e) => setSearch(e.target.value)}\r\n                                />\r\n                            </form>\r\n                            <div className=\"flex flex-col sm:flex-row gap-2 w-full xl:w-auto items-stretch sm:items-center\">\r\n                                {/* Endpoint Selector */}\r\n                                <Select value={selectedEndpoint} onValueChange={setSelectedEndpoint}>\r\n                                    <SelectTrigger className=\"w-full sm:w-[280px] h-10 bg-slate-100 dark:bg-slate-800 border-none font-medium\">\r\n                                        <SelectValue placeholder=\"Select Endpoint\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent className=\"max-h-[400px] w-[var(--radix-select-trigger-width)]\">\r\n                                        <SelectGroup>\r\n                                            <SelectLabel className=\"text-blue-600 font-semibold flex items-center gap-2\">\r\n                                                ≡ƒôª V1 Endpoints\r\n                                            </SelectLabel>\r\n                                            {ENDPOINTS.filter(ep => ep.type === 'v1').map((ep) => (\r\n                                                <SelectItem key={ep.value} value={ep.value}>\r\n                                                    {ep.label}\r\n                                                </SelectItem>\r\n                                            ))}\r\n                                        </SelectGroup>\r\n                                        <SelectGroup>\r\n                                            <SelectLabel className=\"text-amber-600 font-semibold flex items-center gap-2 pt-2\">\r\n                                                ≡ƒô£ Legacy Endpoints\r\n                                            </SelectLabel>\r\n                                            {ENDPOINTS.filter(ep => ep.type === 'legacy').map((ep) => (\r\n                                                <SelectItem key={ep.value} value={ep.value}>\r\n                                                    {ep.label}\r\n                                                </SelectItem>\r\n                                            ))}\r\n                                        </SelectGroup>\r\n                                    </SelectContent>\r\n                                </Select>\r\n\r\n                                {ENDPOINTS.find(ep => ep.value === selectedEndpoint)?.requiresId && (\r\n                                    <div className=\"text-xs text-amber-600 font-medium flex items-center gap-1 bg-amber-50 px-2 py-1 rounded border border-amber-200 justify-center sm:justify-start\">\r\n                                        <AlertTriangle className=\"h-3 w-3\" />\r\n                                        Requires ID\r\n                                    </div>\r\n                                )}\r\n\r\n                                <div className=\"flex gap-2 flex-1 sm:flex-none\">\r\n                                    <Button variant=\"outline\" className=\"gap-2 flex-1 sm:flex-none\" onClick={() => fetchData(true)} disabled={loading || isExporting}>\r\n                                        <Filter className=\"h-4 w-4\" />\r\n                                        Reset\r\n                                    </Button>\r\n                                    <Button\r\n                                        className=\"gap-2 bg-emerald-600 hover:bg-emerald-700 text-white flex-1 sm:flex-none\"\r\n                                        onClick={handleExport}\r\n                                        disabled={loading || isExporting}\r\n                                    >\r\n                                        {isExporting ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : <Download className=\"h-4 w-4\" />}\r\n                                        {isExporting ? `Exporting...` : 'Export'}\r\n                                    </Button>\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n\r\n                        {/* Enhanced Data Table */}\r\n                        {ENDPOINTS.find(ep => ep.value === selectedEndpoint)?.requiresId ? (\r\n                            <div className=\"bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-900 rounded-lg p-8 flex flex-col items-center justify-center text-center gap-3 text-amber-800 dark:text-amber-200 mt-4\">\r\n                                <AlertTriangle className=\"h-10 w-10 opacity-80\" />\r\n                                <div>\r\n                                    <h4 className=\"font-semibold text-lg\">Restricted Endpoint</h4>\r\n                                    <p className=\"max-w-md mx-auto mt-1 text-amber-700 dark:text-amber-300\">\r\n                                        This endpoint (&quot;{ENDPOINTS.find(ep => ep.value === selectedEndpoint)?.label}&quot;) requires specific parameters (like ID) to fetch data.\r\n                                        It cannot be browsed directly without a specific ID context.\r\n                                    </p>\r\n                                </div>\r\n                            </div>\r\n                        ) : (\r\n                            <Card className=\"bg-white dark:bg-slate-900 shadow-sm border-none overflow-hidden flex flex-col h-[600px] relative z-0\">\r\n                                <CardHeader className=\"border-b bg-slate-50/50 dark:bg-slate-950/50 shrink-0\">\r\n                                    <CardTitle>{ENDPOINTS.find(ep => ep.value === selectedEndpoint)?.label || 'Data Paket'}</CardTitle>\r\n                                    <CardDescription>Archive data from INAPROC API. Click row or eye icon for details.</CardDescription>\r\n                                </CardHeader>\r\n                                <CardContent className=\"p-0 flex-1 overflow-hidden relative\">\r\n                                    <div className=\"absolute inset-0 overflow-auto\">\r\n\r\n                                        <table data-slot=\"table\" className=\"caption-bottom text-sm w-max min-w-full\">\r\n                                            <TableHeader className=\"sticky top-0 bg-white dark:bg-slate-900 z-10 shadow-sm\">\r\n                                                <TableRow className=\"bg-slate-50/50 dark:bg-slate-900/50 hover:bg-slate-50/50\">\r\n                                                    <TableHead className=\"w-[50px] whitespace-nowrap\">No</TableHead>\r\n                                                    {columns.map(key => (\r\n                                                        <TableHead key={key} className=\"whitespace-nowrap capitalize font-semibold text-slate-700 dark:text-slate-300\">\r\n                                                            {key.replace(/_/g, ' ')}\r\n                                                        </TableHead>\r\n                                                    ))}\r\n                                                    <TableHead className=\"w-[50px]\"></TableHead>\r\n                                                </TableRow>\r\n                                            </TableHeader>\r\n                                            <TableBody>\r\n                                                {data.length === 0 && !loading ? (\r\n                                                    <TableRow>\r\n                                                        <TableCell colSpan={columns.length + 2} className=\"h-24 text-center text-slate-500\">\r\n                                                            No data found.\r\n                                                        </TableCell>\r\n                                                    </TableRow>\r\n                                                ) : (\r\n                                                    data.map((item, index) => (\r\n                                                        <TableRow\r\n                                                            key={index}\r\n                                                            className=\"hover:bg-blue-50/50 dark:hover:bg-blue-900/20 transition-colors cursor-pointer group border-b border-slate-100 dark:border-slate-800\"\r\n                                                            onClick={(e) => {\r\n                                                                e.stopPropagation();\r\n                                                                openDetails(item);\r\n                                                            }}\r\n                                                        >\r\n                                                            <TableCell className=\"font-medium text-slate-500 text-xs\">{index + 1}</TableCell>\r\n                                                            {columns.map(key => {\r\n                                                                const val = item[key];\r\n                                                                let displayVal: React.ReactNode = val;\r\n\r\n                                                                if (val === null || val === undefined) displayVal = <span className=\"text-slate-300\">-</span>;\r\n                                                                else if (typeof val === 'number' && (key.includes('harga') || key.includes('pagu') || key.includes('nilai') || key.includes('ongkos'))) {\r\n                                                                    displayVal = <span className=\"font-mono text-emerald-600 dark:text-emerald-400\">{formatCurrency(val)}</span>;\r\n                                                                } else if (typeof val === 'string' && (key.includes('tanggal') || val.match(/^\\d{4}-\\d{2}-\\d{2}/))) {\r\n                                                                    try {\r\n                                                                        displayVal = new Date(val).toLocaleDateString();\r\n                                                                    } catch (e) { displayVal = val; }\r\n                                                                } else if (typeof val === 'object') {\r\n                                                                    displayVal = <span className=\"italic text-xs text-slate-400\">Object</span>;\r\n                                                                } else if (key.includes(\"status\")) {\r\n                                                                    displayVal = <Badge variant=\"secondary\" className=\"text-[10px] h-5\">{String(val)}</Badge>\r\n                                                                }\r\n\r\n                                                                return (\r\n                                                                    <TableCell key={key} className=\"whitespace-nowrap text-xs max-w-[300px] truncate\" title={String(val)}>\r\n                                                                        {displayVal}\r\n                                                                    </TableCell>\r\n                                                                )\r\n                                                            })}\r\n                                                            <TableCell>\r\n                                                                <Button variant=\"ghost\" size=\"icon\" className=\"opacity-0 group-hover:opacity-100 transition-opacity h-8 w-8\">\r\n                                                                    <Eye className=\"h-4 w-4 text-blue-600\" />\r\n                                                                </Button>\r\n                                                            </TableCell>\r\n                                                        </TableRow>\r\n                                                    ))\r\n                                                )}\r\n                                            </TableBody>\r\n                                        </table>\r\n                                    </div>\r\n                                </CardContent>\r\n                                {\r\n                                    (hasMore || loading) && (\r\n                                        <div className=\"p-4 border-t flex justify-center bg-slate-50/30 shrink-0 relative z-20\">\r\n                                            <Button\r\n                                                variant=\"ghost\"\r\n                                                onClick={(e) => {\r\n                                                    e.preventDefault();\r\n                                                    e.stopPropagation();\r\n                                                    loadMore();\r\n                                                }}\r\n                                                disabled={loading}\r\n                                                className=\"w-full max-w-xs gap-2\"\r\n                                            >\r\n                                                {loading ? <Loader2 className=\"h-4 w-4 animate-spin\" /> : null}\r\n                                                {loading ? 'Loading more...' : 'Load More Data'}\r\n                                            </Button>\r\n                                        </div>\r\n                                    )\r\n                                }\r\n                            </Card>\r\n                        )}\r\n                    </>\r\n                )}\r\n\r\n            </main >\r\n        </div >\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\detail-sheet.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":15,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":15,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[301,304],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[301,304],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":22,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":22,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[496,499],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[496,499],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport {\r\n    Sheet,\r\n    SheetContent,\r\n    SheetDescription,\r\n    SheetHeader,\r\n    SheetTitle,\r\n} from \"@/components/ui/sheet\";\r\n\r\nimport { ScrollArea } from \"@/components/ui/scroll-area\";\r\n\r\ninterface DetailSheetProps {\r\n    open: boolean;\r\n    onOpenChange: (open: boolean) => void;\r\n    data: any | null;\r\n}\r\n\r\nexport function DetailSheet({ open, onOpenChange, data }: DetailSheetProps) {\r\n    if (!data) return null;\r\n\r\n    // Helper to format currency\r\n    const formatCurrency = (val: any) => {\r\n        const num = parseFloat(val);\r\n        if (isNaN(num)) return val;\r\n        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(num);\r\n    };\r\n\r\n    // Helper to format date\r\n    const formatDate = (val: string) => {\r\n        try {\r\n            return new Date(val).toLocaleDateString('id-ID', {\r\n                weekday: 'long',\r\n                year: 'numeric',\r\n                month: 'long',\r\n                day: 'numeric',\r\n                hour: '2-digit',\r\n                minute: '2-digit'\r\n            });\r\n        } catch {\r\n            return val;\r\n        }\r\n    };\r\n\r\n    return (\r\n        <Sheet open={open} onOpenChange={onOpenChange}>\r\n            <SheetContent className=\"w-[400px] sm:w-[540px] overflow-y-auto\">\r\n                <SheetHeader className=\"mb-6\">\r\n                    <SheetTitle className=\"text-xl font-bold leading-relaxed text-blue-700 dark:text-blue-400\">\r\n                        {data.nama_paket}\r\n                    </SheetTitle>\r\n                    <SheetDescription>\r\n                        Detail lengkap paket pengadaan.\r\n                    </SheetDescription>\r\n                </SheetHeader>\r\n\r\n                <div className=\"space-y-6\">\r\n                    {/* Key Information Card */}\r\n                    <div className=\"bg-slate-50 dark:bg-slate-900 p-4 rounded-lg border space-y-3\">\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div>\r\n                                <p className=\"text-xs font-semibold text-slate-500 uppercase\">Kode RUP</p>\r\n                                <p className=\"font-mono text-sm\">{data.kode_rup}</p>\r\n                            </div>\r\n                            <div>\r\n                                <p className=\"text-xs font-semibold text-slate-500 uppercase\">Pagu</p>\r\n                                <p className=\"font-semibold text-emerald-600 dark:text-emerald-400\">\r\n                                    {formatCurrency(data.pagu)}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-xs font-semibold text-slate-500 uppercase\">Instansi / Satker</p>\r\n                            <p className=\"text-sm font-medium\">{data.nama_klpd}</p>\r\n                            <p className=\"text-xs text-slate-500\">{data.nama_satker}</p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* All Fields List */}\r\n                    <div>\r\n                        <h3 className=\"text-sm font-semibold mb-3 border-b pb-1\">Semua Data (Raw)</h3>\r\n                        <ScrollArea className=\"h-[400px] rounded-md border p-4 bg-slate-50 dark:bg-slate-950/50\">\r\n                            <div className=\"grid grid-cols-1 gap-2 text-sm\">\r\n                                {Object.entries(data).map(([key, value]) => {\r\n                                    // Skip objects/arrays for simple display or JSON stringify them\r\n                                    let displayValue = value;\r\n                                    if (typeof value === 'object' && value !== null) {\r\n                                        displayValue = JSON.stringify(value);\r\n                                    }\r\n                                    // Format specific keys if needed\r\n                                    if (key.includes('pagu') || key.includes('harga')) {\r\n                                        displayValue = formatCurrency(value);\r\n                                    }\r\n                                    if (key.includes('tanggal') || key.includes('waktu')) {\r\n                                        displayValue = formatDate(value as string);\r\n                                    }\r\n\r\n                                    return (\r\n                                        <div key={key} className=\"grid grid-cols-1 sm:grid-cols-3 gap-1 py-1 border-b border-slate-100 dark:border-slate-800 last:border-0\">\r\n                                            <span className=\"font-medium text-slate-500 truncate\" title={key}>{key}</span>\r\n                                            <span className=\"sm:col-span-2 text-slate-900 dark:text-slate-200 break-words font-mono text-xs sm:text-sm\">\r\n                                                {String(displayValue)}\r\n                                            </span>\r\n                                        </div>\r\n                                    );\r\n                                })}\r\n                            </div>\r\n                        </ScrollArea>\r\n                    </div>\r\n                </div>\r\n            </SheetContent>\r\n        </Sheet>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\range-sync-manager.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useCallback' is defined but never used.","line":3,"column":20,"nodeType":"Identifier","messageId":"unusedVar","endLine":3,"endColumn":31,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"useCallback"},"fix":{"range":[34,47],"text":""},"desc":"Remove unused variable \"useCallback\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Calendar' is defined but never used.","line":15,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":15,"endColumn":13,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"Calendar"},"fix":{"range":[367,382],"text":""},"desc":"Remove unused variable \"Calendar\"."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'FileSpreadsheet' is defined but never used.","line":18,"column":5,"nodeType":"Identifier","messageId":"unusedVar","endLine":18,"endColumn":20,"suggestions":[{"messageId":"removeUnusedVar","data":{"varName":"FileSpreadsheet"},"fix":{"range":[406,428],"text":""},"desc":"Remove unused variable \"FileSpreadsheet\"."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3400,3403],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3400,3403],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useCallback } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/components/ui/select';\r\nimport {\r\n    Loader2,\r\n    Calendar,\r\n    Zap,\r\n    History,\r\n    FileSpreadsheet\r\n} from 'lucide-react';\r\nimport { ENDPOINTS, getSyncableEndpoints } from '@/lib/constants';\r\nimport { Progress } from '@/components/ui/progress';\r\n\r\nexport function RangeSyncManager() {\r\n    const [rangeSyncConfig, setRangeSyncConfig] = useState({\r\n        startYear: '2021',\r\n        endYear: '2026',\r\n        currentYear: null as string | null,\r\n        isSyncing: false\r\n    });\r\n\r\n    // Stats interface\r\n    interface SyncStat {\r\n        endpoint: string;\r\n        year: string;\r\n        newRecords: number;\r\n        duplicatesOrTotal: number; // Duplicates for V1, Total for Legacy (Overwrite)\r\n        status: 'success' | 'error';\r\n        message?: string;\r\n    }\r\n\r\n    const [stats, setStats] = useState<SyncStat[]>([]);\r\n\r\n    // Restoring missing state variables\r\n    const [activeTab, setActiveTab] = useState<'v1' | 'legacy'>('v1');\r\n    const [logs, setLogs] = useState<string[]>([]);\r\n    const [progress, setProgress] = useState(0);\r\n    const [syncingEndpoint, setSyncingEndpoint] = useState<string | null>(null);\r\n\r\n    const addLog = (msg: string) => {\r\n        setLogs(prev => [`[${new Date().toLocaleTimeString()}] ${msg}`, ...prev]);\r\n    };\r\n\r\n    const addStat = (stat: SyncStat) => {\r\n        setStats(prev => [...prev, stat]);\r\n    };\r\n\r\n    const syncEndpoint = async (endpoint: string, year: string) => {\r\n        setSyncingEndpoint(endpoint);\r\n        try {\r\n            let isComplete = false;\r\n            let totalNew = 0;\r\n            let totalSkipped = 0;\r\n            let totalRecords = 0;\r\n\r\n            // Loop for pagination within the endpoint\r\n            while (!isComplete) {\r\n                const res = await fetch('/api/sync', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        endpoint,\r\n                        year,\r\n                        batchSize: 100,\r\n                        maxPages: 50,\r\n                    }),\r\n                });\r\n\r\n                const result = await res.json();\r\n                if (!result.success) throw new Error(result.error || 'Sync failed');\r\n\r\n                totalNew += result.newRecords;\r\n                totalSkipped += result.duplicatesSkipped;\r\n                totalRecords = result.totalRecords;\r\n                isComplete = result.isComplete;\r\n\r\n                if (!isComplete) await new Promise((r) => setTimeout(r, 500));\r\n            }\r\n\r\n            const endpointLabel = ENDPOINTS.find(e => e.value === endpoint)?.label || endpoint;\r\n            addLog(`Completed ${endpointLabel} (${year}): ${totalNew} new records.`);\r\n\r\n            addStat({\r\n                endpoint: endpointLabel,\r\n                year,\r\n                newRecords: totalNew,\r\n                duplicatesOrTotal: activeTab === 'v1' ? totalSkipped : totalRecords, // Show context-aware stat\r\n                status: 'success'\r\n            });\r\n\r\n        } catch (error: any) {\r\n            console.error('Sync error:', error);\r\n            const endpointLabel = ENDPOINTS.find(e => e.value === endpoint)?.label || endpoint;\r\n            addLog(`Error syncing ${endpointLabel} (${year}): ${error.message}`);\r\n\r\n            addStat({\r\n                endpoint: endpointLabel,\r\n                year,\r\n                newRecords: 0,\r\n                duplicatesOrTotal: 0,\r\n                status: 'error',\r\n                message: error.message\r\n            });\r\n        } finally {\r\n            setSyncingEndpoint(null);\r\n        }\r\n    };\r\n\r\n    const handleRangeSync = async () => {\r\n        const start = parseInt(rangeSyncConfig.startYear);\r\n        const end = parseInt(rangeSyncConfig.endYear);\r\n\r\n        if (isNaN(start) || isNaN(end) || start > end) {\r\n            alert(\"Invalid year range\");\r\n            return;\r\n        }\r\n\r\n        setRangeSyncConfig(prev => ({ ...prev, isSyncing: true }));\r\n        setLogs([]);\r\n        setStats([]); // Reset stats on new run\r\n        setProgress(0);\r\n        addLog(`Starting ${activeTab.toUpperCase()} range sync from ${start} to ${end}...`);\r\n\r\n        // Filter endpoints based on active tab\r\n        const allEndpoints = getSyncableEndpoints();\r\n        const targetEndpoints = allEndpoints.filter(ep => activeTab === 'v1' ? ep.type === 'v1' : ep.type === 'legacy');\r\n\r\n        if (targetEndpoints.length === 0) {\r\n            addLog(\"No endpoints found for this category.\");\r\n            setRangeSyncConfig(prev => ({ ...prev, isSyncing: false }));\r\n            return;\r\n        }\r\n\r\n        const totalSteps = (end - start + 1) * targetEndpoints.length;\r\n        let completedSteps = 0;\r\n\r\n        try {\r\n            for (let y = start; y <= end; y++) {\r\n                const yearStr = String(y);\r\n                setRangeSyncConfig(prev => ({ ...prev, currentYear: yearStr }));\r\n                addLog(`--- Processing Year ${yearStr} ---`);\r\n\r\n                for (const ep of targetEndpoints) {\r\n                    await syncEndpoint(ep.value, yearStr);\r\n                    completedSteps++;\r\n                    setProgress(Math.round((completedSteps / totalSteps) * 100));\r\n                }\r\n            }\r\n            addLog('Range sync completed successfully.');\r\n        } finally {\r\n            setRangeSyncConfig(prev => ({ ...prev, isSyncing: false, currentYear: null }));\r\n        }\r\n    };\r\n\r\n    // Calculate Summary Stats\r\n    const totalNewRows = stats.reduce((acc, curr) => acc + curr.newRecords, 0);\r\n    const totalProcessed = stats.length;\r\n    const errors = stats.filter(s => s.status === 'error').length;\r\n\r\n    return (\r\n        <div className=\"space-y-6\">\r\n            <Card className=\"bg-white dark:bg-slate-900 border-none shadow-sm\">\r\n                <CardHeader className=\"border-b bg-emerald-50/50 dark:bg-emerald-950/20\">\r\n                    <CardTitle className=\"flex items-center gap-2 text-emerald-700 dark:text-emerald-400\">\r\n                        <History className=\"h-5 w-5\" />\r\n                        Range Sync Manager\r\n                    </CardTitle>\r\n                    <CardDescription>\r\n                        Batch download and synchronize data across multiple years.\r\n                    </CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"p-6 space-y-6\">\r\n                    {/* Category Tabs */}\r\n                    <div className=\"flex gap-2 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg w-fit\">\r\n                        <Button\r\n                            variant={activeTab === 'v1' ? 'default' : 'ghost'}\r\n                            size=\"sm\"\r\n                            className={activeTab === 'v1' ? 'bg-white text-emerald-700 shadow-sm hover:bg-white/90' : 'text-slate-500 hover:text-emerald-700'}\r\n                            onClick={() => setActiveTab('v1')}\r\n                        >\r\n                            V1 API (Modern)\r\n                        </Button>\r\n                        <Button\r\n                            variant={activeTab === 'legacy' ? 'default' : 'ghost'}\r\n                            size=\"sm\"\r\n                            className={activeTab === 'legacy' ? 'bg-white text-amber-700 shadow-sm hover:bg-white/90' : 'text-slate-500 hover:text-amber-700'}\r\n                            onClick={() => setActiveTab('legacy')}\r\n                        >\r\n                            Legacy API (Archive)\r\n                        </Button>\r\n                    </div>\r\n\r\n                    {/* Strategy Info */}\r\n                    <div className={`text-xs p-3 rounded border ${activeTab === 'v1' ? 'bg-blue-50 text-blue-700 border-blue-100' : 'bg-amber-50 text-amber-700 border-amber-100'}`}>\r\n                        {activeTab === 'v1' ? (\r\n                            <p><strong>Strategy: Incremental Sync.</strong> Uses cursors to fetch only new data. Fast and efficient.</p>\r\n                        ) : (\r\n                            <p><strong>Strategy: Overwrite Sync.</strong> Downloads fresh full dataset and replaces existing files to guarantee no duplicates.</p>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"flex flex-col md:flex-row gap-6 items-end\">\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">From Year</label>\r\n                            <Select value={rangeSyncConfig.startYear} onValueChange={(v) => setRangeSyncConfig(prev => ({ ...prev, startYear: v }))}>\r\n                                <SelectTrigger className=\"w-[120px]\">\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {Array.from({ length: 2026 - 2018 + 1 }, (_, i) => 2026 - i).map((y) => (\r\n                                        <SelectItem key={y} value={String(y)}>{y}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                        <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium text-slate-700 dark:text-slate-300\">To Year</label>\r\n                            <Select value={rangeSyncConfig.endYear} onValueChange={(v) => setRangeSyncConfig(prev => ({ ...prev, endYear: v }))}>\r\n                                <SelectTrigger className=\"w-[120px]\">\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    {Array.from({ length: 2026 - 2018 + 1 }, (_, i) => 2026 - i).map((y) => (\r\n                                        <SelectItem key={y} value={String(y)}>{y}</SelectItem>\r\n                                    ))}\r\n                                </SelectContent>\r\n                            </Select>\r\n                        </div>\r\n                        <Button\r\n                            size=\"lg\"\r\n                            className=\"bg-emerald-600 hover:bg-emerald-700 text-white w-full md:w-auto\"\r\n                            onClick={handleRangeSync}\r\n                            disabled={rangeSyncConfig.isSyncing}\r\n                        >\r\n                            {rangeSyncConfig.isSyncing ? (\r\n                                <>\r\n                                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                                    Syncing...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Zap className=\"h-4 w-4 mr-2\" />\r\n                                    Start Range Sync\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n\r\n                    {rangeSyncConfig.isSyncing && (\r\n                        <div className=\"space-y-2\">\r\n                            <div className=\"flex justify-between text-xs text-slate-500\">\r\n                                <span>Progress</span>\r\n                                <span>{progress}%</span>\r\n                            </div>\r\n                            <Progress value={progress} className=\"h-2\" />\r\n                            <div className=\"text-sm text-emerald-600 font-medium animate-pulse\">\r\n                                {rangeSyncConfig.currentYear && syncingEndpoint ?\r\n                                    `Syncing ${ENDPOINTS.find(e => e.value === syncingEndpoint)?.label} (${rangeSyncConfig.currentYear})` :\r\n                                    'Preparing...'}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Scorechart / Stats Panel */}\r\n            {(stats.length > 0 || rangeSyncConfig.isSyncing) && (\r\n                <div className=\"grid gap-6 md:grid-cols-3\">\r\n                    {/* Summary Cards */}\r\n                    <Card className=\"md:col-span-1 bg-white dark:bg-slate-900 border shadow-sm h-fit\">\r\n                        <CardHeader className=\"py-4 border-b\">\r\n                            <CardTitle className=\"text-base\">Sync Scorecard</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"p-4 space-y-4\">\r\n                            <div className=\"p-4 rounded-lg bg-emerald-50 text-emerald-900\">\r\n                                <p className=\"text-xs font-semibold uppercase opacity-70\">Total New Rows</p>\r\n                                <p className=\"text-3xl font-bold\">{totalNewRows.toLocaleString()}</p>\r\n                            </div>\r\n                            <div className=\"grid grid-cols-2 gap-2\">\r\n                                <div className=\"p-3 rounded-lg bg-slate-50\">\r\n                                    <p className=\"text-xs text-slate-500\">Processed</p>\r\n                                    <p className=\"text-lg font-semibold\">{totalProcessed}</p>\r\n                                </div>\r\n                                <div className=\"p-3 rounded-lg bg-red-50 text-red-900\">\r\n                                    <p className=\"text-xs opacity-70\">Errors</p>\r\n                                    <p className=\"text-lg font-semibold\">{errors}</p>\r\n                                </div>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n\r\n                    {/* Detailed Table */}\r\n                    <Card className=\"md:col-span-2 bg-white dark:bg-slate-900 border shadow-sm\">\r\n                        <CardHeader className=\"py-4 border-b\">\r\n                            <CardTitle className=\"text-base\">Detailed Breakdown</CardTitle>\r\n                        </CardHeader>\r\n                        <CardContent className=\"p-0\">\r\n                            <div className=\"max-h-[300px] overflow-y-auto\">\r\n                                <table className=\"w-full text-sm text-left\">\r\n                                    <thead className=\"bg-slate-50 text-slate-500 font-medium sticky top-0\">\r\n                                        <tr>\r\n                                            <th className=\"px-4 py-2\">Endpoint</th>\r\n                                            <th className=\"px-4 py-2 w-[80px]\">Year</th>\r\n                                            <th className=\"px-4 py-2 text-right w-[100px]\">New Rows</th>\r\n                                            <th className=\"px-4 py-2 text-right\">\r\n                                                {activeTab === 'v1' ? 'Skipped' : 'Total Size'}\r\n                                            </th>\r\n                                            <th className=\"px-4 py-2 w-[40px]\"></th>\r\n                                        </tr>\r\n                                    </thead>\r\n                                    <tbody className=\"divide-y\">\r\n                                        {stats.map((row, i) => (\r\n                                            <tr key={i} className={`hover:bg-slate-50/50 ${row.newRecords > 0 ? 'bg-emerald-50/10' : ''}`}>\r\n                                                <td className=\"px-4 py-2 truncate max-w-[200px]\" title={row.endpoint}>\r\n                                                    {row.endpoint.replace('Legacy:', '').replace('(Archive)', '').trim()}\r\n                                                </td>\r\n                                                <td className=\"px-4 py-2\">{row.year}</td>\r\n                                                <td className={`px-4 py-2 text-right font-medium ${row.newRecords > 0 ? 'text-emerald-600' : 'text-slate-400'}`}>\r\n                                                    {row.newRecords > 0 ? `+${row.newRecords}` : '-'}\r\n                                                </td>\r\n                                                <td className=\"px-4 py-2 text-right text-slate-500\">\r\n                                                    {row.duplicatesOrTotal.toLocaleString()}\r\n                                                </td>\r\n                                                <td className=\"px-4 py-2 text-center\">\r\n                                                    {row.status === 'success' ? (\r\n                                                        <span className=\"inline-block w-2 h-2 rounded-full bg-emerald-500\" />\r\n                                                    ) : (\r\n                                                        <span className=\"inline-block w-2 h-2 rounded-full bg-red-500\" title={row.message} />\r\n                                                    )}\r\n                                                </td>\r\n                                            </tr>\r\n                                        ))}\r\n                                    </tbody>\r\n                                </table>\r\n                            </div>\r\n                        </CardContent>\r\n                    </Card>\r\n                </div>\r\n            )}\r\n\r\n            <Card className=\"bg-slate-50 dark:bg-slate-900 border shadow-inner\">\r\n                <CardHeader className=\"pb-2\">\r\n                    <CardTitle className=\"text-sm font-medium text-slate-500\">Operation Logs</CardTitle>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"h-[150px] overflow-y-auto font-mono text-xs space-y-1 p-2 bg-white dark:bg-black rounded border\">\r\n                        {logs.length === 0 ? (\r\n                            <span className=\"text-slate-400 italic\">No logs yet...</span>\r\n                        ) : (\r\n                            logs.map((log, i) => (\r\n                                <div key={i} className=\"border-b border-slate-100 dark:border-slate-800 pb-1 last:border-0\">\r\n                                    {log}\r\n                                </div>\r\n                            ))\r\n                        )}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\sync-manager.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":147,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4499,4502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4499,4502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect, useCallback } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport {\r\n    Select,\r\n    SelectContent,\r\n    SelectItem,\r\n    SelectTrigger,\r\n    SelectValue,\r\n} from '@/components/ui/select';\r\nimport {\r\n    Loader2,\r\n    RefreshCw,\r\n    Download,\r\n    CheckCircle,\r\n    AlertCircle,\r\n    Clock,\r\n    FolderOpen,\r\n    Zap,\r\n    PlayCircle,\r\n    PauseCircle,\r\n} from 'lucide-react';\r\nimport { ENDPOINTS, getSyncableEndpoints } from '@/lib/constants';\r\n\r\ninterface SyncState {\r\n    lastCursor: string | null;\r\n    lastSyncDate: string;\r\n    totalRecords: number;\r\n    filePath: string;\r\n}\r\n\r\ninterface EndpointStatus {\r\n    endpoint: string;\r\n    label: string;\r\n    years: { year: string; state: SyncState }[];\r\n    lastSynced: string | null;\r\n}\r\n\r\ninterface ScheduleConfig {\r\n    enabled: boolean;\r\n    type: 'daily' | 'weekly';\r\n    lastRun: string | null;\r\n    endpoints: string[];\r\n}\r\n\r\ninterface SyncManagerProps {\r\n    year: string;\r\n    onSyncComplete?: () => void;\r\n}\r\n\r\nexport function SyncManager({ year, onSyncComplete }: SyncManagerProps) {\r\n    const [statuses, setStatuses] = useState<EndpointStatus[]>([]);\r\n    const [schedule, setSchedule] = useState<ScheduleConfig | null>(null);\r\n    const [loading, setLoading] = useState(false);\r\n    const [syncing, setSyncing] = useState<string | null>(null);\r\n    const [batchSyncing, setBatchSyncing] = useState(false);\r\n    const [syncProgress, setSyncProgress] = useState<Record<string, { status: string; records: number }>>({});\r\n    const [basePath, setBasePath] = useState<string>('');\r\n\r\n    // Fetch sync status\r\n    const fetchStatus = useCallback(async () => {\r\n        setLoading(true);\r\n        try {\r\n            const res = await fetch('/api/sync/status');\r\n            const data = await res.json();\r\n            setStatuses(data.endpoints || []);\r\n            setSchedule(data.schedule || null);\r\n            setBasePath(data.basePath || '');\r\n        } catch (error) {\r\n            console.error('Failed to fetch status:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    }, []);\r\n\r\n    useEffect(() => {\r\n        fetchStatus();\r\n    }, [fetchStatus]);\r\n\r\n    // Reset sync progress when year changes\r\n    useEffect(() => {\r\n        setSyncProgress({});\r\n    }, [year]);\r\n\r\n    // Sync a single endpoint\r\n    const syncEndpoint = async (endpoint: string) => {\r\n        setSyncing(endpoint);\r\n\r\n        setSyncProgress((prev) => ({\r\n            ...prev,\r\n            [endpoint]: { status: 'syncing', records: 0 },\r\n        }));\r\n\r\n        try {\r\n            let isComplete = false;\r\n\r\n\r\n            while (!isComplete) {\r\n                const res = await fetch('/api/sync', {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        endpoint,\r\n                        year,\r\n                        batchSize: 100, // Max limit allowed by API\r\n                        maxPages: 50, // Process 50 pages (5000 records) per batch write\r\n                    }),\r\n                });\r\n\r\n                const result = await res.json();\r\n\r\n                if (!result.success) {\r\n                    throw new Error(result.error || 'Sync failed');\r\n                }\r\n\r\n\r\n                isComplete = result.isComplete;\r\n\r\n                setSyncProgress((prev) => ({\r\n                    ...prev,\r\n                    [endpoint]: {\r\n                        status: isComplete ? 'complete' : 'syncing',\r\n                        records: result.totalRecords,\r\n                    },\r\n                }));\r\n\r\n                // Small delay between batches\r\n                if (!isComplete) {\r\n                    await new Promise((r) => setTimeout(r, 500));\r\n                }\r\n            }\r\n\r\n            setSyncProgress((prev) => ({\r\n                ...prev,\r\n                [endpoint]: { status: 'complete', records: prev[endpoint]?.records || 0 },\r\n            }));\r\n\r\n            // Only refetch status if NOT in a batch process (optimization) to avoid flickering\r\n            if (!batchSyncing) {\r\n                await fetchStatus();\r\n            }\r\n            onSyncComplete?.();\r\n        } catch (error: any) {\r\n            console.error('Sync error:', error);\r\n            setSyncProgress((prev) => ({\r\n                ...prev,\r\n                [endpoint]: { status: 'error', records: 0 },\r\n            }));\r\n        } finally {\r\n            setSyncing(null);\r\n        }\r\n    };\r\n\r\n    // Batch sync all endpoints (excluding detail endpoints that require IDs)\r\n    const batchSync = async () => {\r\n        setBatchSyncing(true);\r\n        const syncableEndpoints = getSyncableEndpoints();\r\n\r\n        for (const ep of syncableEndpoints) {\r\n            if (!batchSyncing) break; // Allow cancellation logic if we add it\r\n            await syncEndpoint(ep.value);\r\n        }\r\n\r\n        setBatchSyncing(false);\r\n        await fetchStatus();\r\n    };\r\n\r\n    // Update schedule\r\n    const updateSchedule = async (updates: Partial<ScheduleConfig>) => {\r\n        try {\r\n            const res = await fetch('/api/sync/schedule', {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify(updates),\r\n            });\r\n            const data = await res.json();\r\n            setSchedule(data.schedule);\r\n        } catch (error) {\r\n            console.error('Failed to update schedule:', error);\r\n        }\r\n    };\r\n\r\n    // Format date\r\n    const formatDate = (dateStr: string | null) => {\r\n        if (!dateStr) return 'Belum pernah sync';\r\n        const date = new Date(dateStr);\r\n        return date.toLocaleString('id-ID', {\r\n            day: 'numeric',\r\n            month: 'short',\r\n            year: 'numeric',\r\n            hour: '2-digit',\r\n            minute: '2-digit',\r\n        });\r\n    };\r\n\r\n    // Get status badge for endpoint\r\n    const getStatusBadge = (endpoint: string, status: EndpointStatus) => {\r\n        const progress = syncProgress[endpoint];\r\n        const yearState = status.years.find((y) => y.year === year);\r\n\r\n        if (progress?.status === 'syncing') {\r\n            return (\r\n                <Badge variant=\"secondary\" className=\"gap-1 bg-blue-100 text-blue-700\">\r\n                    <Loader2 className=\"h-3 w-3 animate-spin\" />\r\n                    Syncing...\r\n                </Badge>\r\n            );\r\n        }\r\n\r\n        if (progress?.status === 'complete') {\r\n            return (\r\n                <Badge variant=\"secondary\" className=\"gap-1 bg-green-100 text-green-700\">\r\n                    <CheckCircle className=\"h-3 w-3\" />\r\n                    Complete\r\n                </Badge>\r\n            );\r\n        }\r\n\r\n        if (progress?.status === 'error') {\r\n            return (\r\n                <Badge variant=\"secondary\" className=\"gap-1 bg-red-100 text-red-700\">\r\n                    <AlertCircle className=\"h-3 w-3\" />\r\n                    Error\r\n                </Badge>\r\n            );\r\n        }\r\n\r\n        if (yearState) {\r\n            return (\r\n                <Badge variant=\"secondary\" className=\"gap-1 bg-slate-100 text-slate-700\">\r\n                    <Clock className=\"h-3 w-3\" />\r\n                    {yearState.state.totalRecords.toLocaleString()} records\r\n                </Badge>\r\n            );\r\n        }\r\n\r\n        return (\r\n            <Badge variant=\"outline\" className=\"text-slate-400\">\r\n                Belum sync\r\n            </Badge>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <Card className=\"bg-white dark:bg-slate-900 border-none shadow-sm\">\r\n            <CardHeader className=\"border-b bg-slate-50/50 dark:bg-slate-950/50\">\r\n                <div className=\"flex items-center justify-between\">\r\n                    <div>\r\n                        <CardTitle className=\"flex items-center gap-2\">\r\n                            <FolderOpen className=\"h-5 w-5 text-blue-600\" />\r\n                            Sync Manager\r\n                        </CardTitle>\r\n                        <CardDescription>\r\n                            Download dan simpan data INAPROC ke folder lokal\r\n                        </CardDescription>\r\n                    </div>\r\n                    <div className=\"flex gap-2\">\r\n                        <Button\r\n                            variant=\"outline\"\r\n                            size=\"sm\"\r\n                            onClick={fetchStatus}\r\n                            disabled={loading}\r\n                        >\r\n                            <RefreshCw className={`h-4 w-4 mr-1 ${loading ? 'animate-spin' : ''}`} />\r\n                            Refresh\r\n                        </Button>\r\n                        <Button\r\n                            size=\"sm\"\r\n                            variant=\"outline\"\r\n                            onClick={async () => {\r\n                                // Explicit sequential sync (working 1-by-1)\r\n                                if (syncing) return;\r\n                                const syncableEndpoints = getSyncableEndpoints();\r\n                                for (const ep of syncableEndpoints) {\r\n                                    await syncEndpoint(ep.value);\r\n                                }\r\n                                await fetchStatus();\r\n                            }}\r\n                            disabled={syncing !== null || batchSyncing}\r\n                            className=\"bg-white border-blue-200 text-blue-700 hover:bg-blue-50\"\r\n                        >\r\n                            <PlayCircle className=\"h-4 w-4 mr-1\" />\r\n                            Auto Sync (Seq)\r\n                        </Button>\r\n                        <Button\r\n                            size=\"sm\"\r\n                            onClick={batchSync}\r\n                            disabled={batchSyncing || syncing !== null}\r\n                            className=\"bg-gradient-to-r from-blue-600 to-indigo-600\"\r\n                        >\r\n                            {batchSyncing ? (\r\n                                <>\r\n                                    <Loader2 className=\"h-4 w-4 mr-1 animate-spin\" />\r\n                                    Batch Syncing...\r\n                                </>\r\n                            ) : (\r\n                                <>\r\n                                    <Zap className=\"h-4 w-4 mr-1\" />\r\n                                    Sync Semua\r\n                                </>\r\n                            )}\r\n                        </Button>\r\n                    </div>\r\n                </div>\r\n            </CardHeader>\r\n\r\n            <CardContent className=\"p-4 space-y-4\">\r\n                {/* Schedule Section */}\r\n                <div className=\"bg-gradient-to-r from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 rounded-lg p-4 border border-indigo-100 dark:border-indigo-900\">\r\n                    <div className=\"flex items-center justify-between flex-wrap gap-4\">\r\n                        <div className=\"flex items-center gap-3\">\r\n                            <Clock className=\"h-5 w-5 text-indigo-600\" />\r\n                            <div>\r\n                                <h4 className=\"font-semibold text-sm\">Auto-Sync Schedule</h4>\r\n                                <p className=\"text-xs text-slate-500\">\r\n                                    {schedule?.lastRun\r\n                                        ? `Terakhir: ${formatDate(schedule.lastRun)}`\r\n                                        : 'Jadwalkan sync otomatis'}\r\n                                </p>\r\n                            </div>\r\n                        </div>\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <Select\r\n                                value={schedule?.type || 'daily'}\r\n                                onValueChange={(value) =>\r\n                                    updateSchedule({ type: value as 'daily' | 'weekly' })\r\n                                }\r\n                            >\r\n                                <SelectTrigger className=\"w-[120px] h-8 text-xs bg-white dark:bg-slate-900\">\r\n                                    <SelectValue />\r\n                                </SelectTrigger>\r\n                                <SelectContent>\r\n                                    <SelectItem value=\"daily\">Harian</SelectItem>\r\n                                    <SelectItem value=\"weekly\">Mingguan</SelectItem>\r\n                                </SelectContent>\r\n                            </Select>\r\n                            <Button\r\n                                variant={schedule?.enabled ? 'default' : 'outline'}\r\n                                size=\"sm\"\r\n                                onClick={() => updateSchedule({ enabled: !schedule?.enabled })}\r\n                                className={schedule?.enabled ? 'bg-green-600 hover:bg-green-700' : ''}\r\n                            >\r\n                                {schedule?.enabled ? (\r\n                                    <>\r\n                                        <PauseCircle className=\"h-4 w-4 mr-1\" />\r\n                                        Aktif\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <PlayCircle className=\"h-4 w-4 mr-1\" />\r\n                                        Aktifkan\r\n                                    </>\r\n                                )}\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Endpoints List */}\r\n                <div className=\"space-y-2\">\r\n                    <h4 className=\"font-semibold text-sm text-slate-600\">\r\n                        Endpoints ({ENDPOINTS.length})\r\n                    </h4>\r\n                    <ScrollArea className=\"h-[400px] rounded-md border\">\r\n                        <div className=\"p-2 space-y-1\">\r\n                            {statuses.length === 0 && !loading ? (\r\n                                <div className=\"text-center py-8 text-slate-400\">\r\n                                    Belum ada data sync\r\n                                </div>\r\n                            ) : (\r\n                                statuses.map((status) => {\r\n                                    const yearState = status.years.find((y) => y.year === year);\r\n                                    const progress = syncProgress[status.endpoint];\r\n\r\n                                    return (\r\n                                        <div\r\n                                            key={status.endpoint}\r\n                                            className=\"flex items-center justify-between p-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors border border-transparent hover:border-slate-200 dark:hover:border-slate-700\"\r\n                                        >\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    <span className=\"font-medium text-sm truncate\">\r\n                                                        {status.label}\r\n                                                    </span>\r\n                                                    {getStatusBadge(status.endpoint, status)}\r\n                                                </div>\r\n                                                <div className=\"text-xs text-slate-400 mt-1 flex items-center gap-2\">\r\n                                                    {yearState && (\r\n                                                        <>\r\n                                                            <span>≡ƒôü {yearState.state.filePath}</span>\r\n                                                            <span>ΓÇó</span>\r\n                                                            <span>{formatDate(yearState.state.lastSyncDate)}</span>\r\n                                                        </>\r\n                                                    )}\r\n                                                    {progress?.records > 0 && (\r\n                                                        <span className=\"text-blue-500\">\r\n                                                            {progress.records.toLocaleString()} records\r\n                                                        </span>\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                            <Button\r\n                                                variant=\"ghost\"\r\n                                                size=\"sm\"\r\n                                                onClick={() => syncEndpoint(status.endpoint)}\r\n                                                disabled={syncing !== null || batchSyncing}\r\n                                                className=\"shrink-0\"\r\n                                            >\r\n                                                {syncing === status.endpoint ? (\r\n                                                    <Loader2 className=\"h-4 w-4 animate-spin\" />\r\n                                                ) : (\r\n                                                    <Download className=\"h-4 w-4\" />\r\n                                                )}\r\n                                            </Button>\r\n                                        </div>\r\n                                    );\r\n                                })\r\n                            )}\r\n                        </div>\r\n                    </ScrollArea>\r\n                </div>\r\n\r\n                {/* Footer Info */}\r\n                <div className=\"text-xs text-slate-400 flex items-center gap-2 pt-2 border-t\">\r\n                    <FolderOpen className=\"h-3 w-3\" />\r\n                    <span>Data disimpan ke: {basePath}</span>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\badge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\button.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\progress.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\sheet.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\lib\\constants.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\lib\\drive-config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\lib\\excel-service.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":24,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":24,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[618,621],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[618,621],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1507,1510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1507,1510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'endpointName' is assigned a value but never used.","line":63,"column":15,"nodeType":"Identifier","messageId":"unusedVar","endLine":63,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":70,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":70,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2577,2580],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2577,2580],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":71,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":71,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2651,2654],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2651,2654],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":95,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3314,3317],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3314,3317],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":33,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":36,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3794,3797],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3794,3797],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":168,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":168,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6141,6144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6141,6144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6674,6677],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6674,6677],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":230,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8210,8213],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8210,8213],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":276,"column":14,"nodeType":"Identifier","messageId":"unusedVar","endLine":276,"endColumn":19}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Excel Service\r\n * Handles Excel file operations with deduplication support\r\n */\r\n\r\nimport * as fs from 'fs';\r\nimport * as path from 'path';\r\nimport * as XLSX from 'xlsx';\r\nimport { getFilePath, getUniqueKeyFields } from './drive-config';\r\nimport { ensureEndpointFolder } from './sync-state';\r\n\r\nexport interface ExcelOperationResult {\r\n    success: boolean;\r\n    newRecords: number;\r\n    duplicatesSkipped: number;\r\n    totalRecords: number;\r\n    filePath: string;\r\n    error?: string;\r\n}\r\n\r\n/**\r\n * Generate a unique key for a record based on endpoint-specific fields\r\n */\r\nfunction generateRecordKey(record: any, keyFields: string[]): string {\r\n    return keyFields\r\n        .map(field => {\r\n            // Support \"OR\" logic for fields (e.g. \"kode_rup||kd_rup\")\r\n            if (field.includes('||')) {\r\n                const options = field.split('||');\r\n                for (const opt of options) {\r\n                    // Check strict non-null/undefined. Empty string might be valid but usually ID is not empty.\r\n                    if (record[opt] !== undefined && record[opt] !== null && String(record[opt]).trim() !== '') {\r\n                        return String(record[opt]);\r\n                    }\r\n                }\r\n                return '';\r\n            }\r\n            return String(record[field] || '');\r\n        })\r\n        .join('|');\r\n}\r\n\r\n/**\r\n * Load existing records from Excel file\r\n */\r\nexport async function loadExistingRecords(\r\n    filePath: string\r\n): Promise<{ records: any[]; keys: Set<string>; keyFields: string[] }> {\r\n    if (!fs.existsSync(filePath)) {\r\n        return { records: [], keys: new Set(), keyFields: [] };\r\n    }\r\n\r\n    try {\r\n        // Use buffer approach for better Windows compatibility\r\n        const buffer = fs.readFileSync(filePath);\r\n        const workbook = XLSX.read(buffer, { type: 'buffer' });\r\n        const sheetName = workbook.SheetNames[0];\r\n        const sheet = workbook.Sheets[sheetName];\r\n        const records = XLSX.utils.sheet_to_json(sheet);\r\n\r\n        // Extract endpoint from file path to get key fields\r\n        const fileName = path.basename(filePath, '.xlsx');\r\n        const endpointName = fileName.split('_')[0];\r\n\r\n        // Try to find key fields from the metadata sheet or use default\r\n        let keyFields: string[] = ['kode_rup']; // Default\r\n        if (workbook.SheetNames.includes('_metadata')) {\r\n            const metaSheet = workbook.Sheets['_metadata'];\r\n            const metaData = XLSX.utils.sheet_to_json(metaSheet);\r\n            if (metaData.length > 0 && (metaData[0] as any).keyFields) {\r\n                keyFields = JSON.parse((metaData[0] as any).keyFields);\r\n            }\r\n        }\r\n\r\n        // Build set of existing keys for fast deduplication\r\n        const keys = new Set<string>();\r\n        records.forEach(record => {\r\n            const key = generateRecordKey(record, keyFields);\r\n            keys.add(key);\r\n        });\r\n\r\n        return { records, keys, keyFields };\r\n    } catch (error) {\r\n        console.error('Error loading existing records:', error);\r\n        return { records: [], keys: new Set(), keyFields: [] };\r\n    }\r\n}\r\n\r\n/**\r\n * Append new records to Excel file with deduplication\r\n */\r\nexport async function appendToExcel(\r\n    endpoint: string,\r\n    year: string,\r\n    newData: any[]\r\n): Promise<ExcelOperationResult> {\r\n    const filePath = getFilePath(endpoint, year);\r\n    const keyFields = getUniqueKeyFields(endpoint);\r\n\r\n    try {\r\n        // Ensure folder exists\r\n        await ensureEndpointFolder(endpoint);\r\n\r\n        // Load existing data\r\n        const { records: existingRecords, keys: existingKeys } = await loadExistingRecords(filePath);\r\n\r\n        // Filter out duplicates\r\n        let duplicatesSkipped = 0;\r\n        const uniqueNewRecords: any[] = [];\r\n\r\n        console.log(`Deduplication using keys: [${keyFields.join(', ')}]`);\r\n        console.log(`Existing records: ${existingRecords.length}, New data batch: ${newData.length}`);\r\n\r\n        for (let i = 0; i < newData.length; i++) {\r\n            const record = newData[i];\r\n            let key = generateRecordKey(record, keyFields);\r\n\r\n            // If key is empty or just pipe separators, use a fallback with all fields hash\r\n            if (!key || key === '' || key.split('|').every(k => k === '')) {\r\n                // Create a hash from all field values as fallback\r\n                key = `__row_${JSON.stringify(record)}`;\r\n            }\r\n\r\n            if (!existingKeys.has(key)) {\r\n                uniqueNewRecords.push(record);\r\n                existingKeys.add(key);\r\n            } else {\r\n                duplicatesSkipped++;\r\n            }\r\n        }\r\n\r\n        console.log(`New unique records: ${uniqueNewRecords.length}, Duplicates skipped: ${duplicatesSkipped}`);\r\n\r\n        // Combine existing and new records\r\n        const allRecords = [...existingRecords, ...uniqueNewRecords];\r\n\r\n        // Create workbook\r\n        const workbook = XLSX.utils.book_new();\r\n\r\n        // Add data sheet\r\n        const dataSheet = XLSX.utils.json_to_sheet(allRecords);\r\n        XLSX.utils.book_append_sheet(workbook, dataSheet, `Data ${year}`);\r\n\r\n        // Add metadata sheet for deduplication info\r\n        const metaData = [{\r\n            endpoint,\r\n            year,\r\n            keyFields: JSON.stringify(keyFields),\r\n            lastUpdated: new Date().toISOString(),\r\n            totalRecords: allRecords.length,\r\n        }];\r\n        const metaSheet = XLSX.utils.json_to_sheet(metaData);\r\n        XLSX.utils.book_append_sheet(workbook, metaSheet, '_metadata');\r\n\r\n        // Write file using buffer approach for better Windows compatibility\r\n        console.log('Writing Excel file to:', filePath);\r\n        const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\r\n        fs.writeFileSync(filePath, buffer);\r\n        console.log('Excel file written successfully');\r\n\r\n        return {\r\n            success: true,\r\n            newRecords: uniqueNewRecords.length,\r\n            duplicatesSkipped,\r\n            totalRecords: allRecords.length,\r\n            filePath,\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error appending to Excel:', error);\r\n        return {\r\n            success: false,\r\n            newRecords: 0,\r\n            duplicatesSkipped: 0,\r\n            totalRecords: 0,\r\n            filePath,\r\n            error: error.message,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Overwrite Excel file with new data (Safe Full Sync)\r\n * Used for Legacy endpoints to ensure no duplicates by replacing the entire file\r\n */\r\nexport async function overwriteExcel(\r\n    endpoint: string,\r\n    year: string,\r\n    allData: any[]\r\n): Promise<ExcelOperationResult> {\r\n    const filePath = getFilePath(endpoint, year);\r\n    const keyFields = getUniqueKeyFields(endpoint);\r\n\r\n    try {\r\n        // Ensure folder exists\r\n        await ensureEndpointFolder(endpoint);\r\n\r\n        console.log(`Overwrite Strategy: Writing ${allData.length} records to ${filePath}`);\r\n\r\n        // Create new workbook\r\n        const workbook = XLSX.utils.book_new();\r\n\r\n        // Add data sheet\r\n        const dataSheet = XLSX.utils.json_to_sheet(allData);\r\n        XLSX.utils.book_append_sheet(workbook, dataSheet, `Data ${year}`);\r\n\r\n        // Add metadata sheet\r\n        const metaData = [{\r\n            endpoint,\r\n            year,\r\n            keyFields: JSON.stringify(keyFields),\r\n            lastUpdated: new Date().toISOString(),\r\n            totalRecords: allData.length,\r\n            syncType: 'overwrite'\r\n        }];\r\n        const metaSheet = XLSX.utils.json_to_sheet(metaData);\r\n        XLSX.utils.book_append_sheet(workbook, metaSheet, '_metadata');\r\n\r\n        // Write file (overwriting existing)\r\n        const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\r\n        fs.writeFileSync(filePath, buffer);\r\n        console.log('Excel file overwritten successfully');\r\n\r\n        return {\r\n            success: true,\r\n            newRecords: allData.length, // In overwrite mode, all records are \"freshly written\"\r\n            duplicatesSkipped: 0,\r\n            totalRecords: allData.length,\r\n            filePath,\r\n        };\r\n    } catch (error: any) {\r\n        console.error('Error overwriting Excel:', error);\r\n        return {\r\n            success: false,\r\n            newRecords: 0,\r\n            duplicatesSkipped: 0,\r\n            totalRecords: 0,\r\n            filePath,\r\n            error: error.message,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Get file info for an endpoint/year\r\n */\r\nexport async function getFileInfo(\r\n    endpoint: string,\r\n    year: string\r\n): Promise<{\r\n    exists: boolean;\r\n    path: string;\r\n    size: number;\r\n    recordCount: number;\r\n}> {\r\n    const filePath = getFilePath(endpoint, year);\r\n\r\n    if (!fs.existsSync(filePath)) {\r\n        return {\r\n            exists: false,\r\n            path: filePath,\r\n            size: 0,\r\n            recordCount: 0,\r\n        };\r\n    }\r\n\r\n    try {\r\n        const stats = fs.statSync(filePath);\r\n        const { records } = await loadExistingRecords(filePath);\r\n\r\n        return {\r\n            exists: true,\r\n            path: filePath,\r\n            size: stats.size,\r\n            recordCount: records.length,\r\n        };\r\n    } catch (error) {\r\n        return {\r\n            exists: false,\r\n            path: filePath,\r\n            size: 0,\r\n            recordCount: 0,\r\n        };\r\n    }\r\n}\r\n\r\n/**\r\n * Delete data file for an endpoint/year (for testing or reset)\r\n */\r\nexport async function deleteDataFile(\r\n    endpoint: string,\r\n    year: string\r\n): Promise<boolean> {\r\n    const filePath = getFilePath(endpoint, year);\r\n\r\n    if (fs.existsSync(filePath)) {\r\n        try {\r\n            fs.unlinkSync(filePath);\r\n            return true;\r\n        } catch (error) {\r\n            console.error('Error deleting file:', error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    return true;\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\lib\\sync-state.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\User\\Documents\\Aldiva\\App\\web-app\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
